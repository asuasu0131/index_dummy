<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>スマパ - 駐車場ナビ</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
/* ===== 基本スタイル ===== */
body {
  font-family: 'Inter', sans-serif;
  background: linear-gradient(180deg, #e0f7fa, #ffffff);
  margin: 0;
  padding: 8px;
  text-align: center;
  color: #333;
}

h1 {
  font-size: clamp(20px,5vw,28px);
  font-weight: 700;
  margin: 10px 0 4px 0;
  color: #00796b;
}

#location {
  background: rgba(255,255,255,0.95);
  padding: 10px 12px;
  margin-bottom: 12px;
  border-radius: 12px;
  font-size: clamp(12px,3vw,14px);
  box-shadow: 0 3px 8px rgba(0,0,0,0.15);
}

/* 方位センサボタン */
button {
  background: linear-gradient(45deg,#26c6da,#00acc1);
  color: white;
  border: none;
  padding: 8px 14px;
  margin-bottom: 10px;
  border-radius: 20px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 3px 8px rgba(0,0,0,0.2);
  transition: all 0.2s;
}
button:hover {
  transform: scale(1.05);
}

/* ===== 駐車場エリア ===== */
#parking-lot {
  position: relative;
  width: 100%;
  max-width: 900px;
  aspect-ratio: 9 / 6.5;
  margin: auto;
  background: #b2dfdb;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 8px 16px rgba(0,0,0,0.2);
}

/* ===== 駐車ロッド ===== */
.rod {
  position: absolute;
  width: 30%;
  height: 18%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 700;
  font-size: clamp(14px,3.5vw,24px);
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
  transition: all 0.2s;
}

.empty { background: #4caf50; }
.full  { background: #f44336; }

.nearest {
  outline: 3px solid #ffeb3b;
  box-shadow: 0 0 18px rgba(255,235,59,0.9);
  transform: scale(1.05);
}

/* 自分の位置マーカー */
#user-marker {
  position: absolute;
  width: 18px;
  height: 18px;
  background: #0288d1;
  border-radius: 50%;
  border: 3px solid white;
  z-index: 1000;
  display: none;
  box-shadow: 0 2px 6px rgba(0,0,0,0.4);
}

/* 矢印 */
#arrow {
  position: absolute;
  height: 3px;
  background: #ff5722;
  transform-origin: left center;
  z-index: 900;
  display: none;
  border-radius: 2px;
  box-shadow: 0 0 6px rgba(255,87,34,0.8);
}

.distance {
  font-size: clamp(10px,2.5vw,14px);
  font-weight: 500;
  margin-top: 2px;
}

/* スマホ最適化 */
@media (max-width: 600px) {
  body { padding: 4px; }
  .rod { border-radius: 8px; font-size: clamp(12px,4vw,18px); }
  #user-marker { width:14px; height:14px; }
  #arrow { height:2px; }
}
</style>
</head>

<body>

<h1>スマパ</h1>
<div id="location">位置情報を取得中...</div>
<button onclick="requestOrientationPermission()">方位センサを有効化</button>

<div id="parking-lot">
  <div id="user-marker"></div>
  <div id="arrow"></div>
</div>

<script>
/* ===== 駐車場 GPS 範囲 ===== */
const MIN_LAT = 38.167755;
const MAX_LAT = 38.167785;
const MIN_LNG = 140.866325;
const MAX_LNG = 140.866355;

/* ===== ダミー駐車ロッド ===== */
const rods = [
  { id:"A1", label:"A1", lat:38.167760, lng:140.866330, status:0, row:1, col:1 },
  { id:"A2", label:"A2", lat:38.167764, lng:140.866334, status:1, row:2, col:1 },
  { id:"A3", label:"A3", lat:38.167770, lng:140.866338, status:0, row:3, col:1 },
  { id:"B1", label:"B1", lat:38.167774, lng:140.866342, status:0, row:1, col:3 },
  { id:"B2", label:"B2", lat:38.167778, lng:140.866346, status:1, row:2, col:3 },
  { id:"B3", label:"B3", lat:38.167782, lng:140.866350, status:0, row:3, col:3 }
];

let userLat=null, userLng=null;
let deviceHeading=null; // スマホ方位角

/* ===== 距離計算 ===== */
function calcDistance(lat1,lng1,lat2,lng2){
  const R=6371e3;
  const φ1=lat1*Math.PI/180;
  const φ2=lat2*Math.PI/180;
  const dφ=(lat2-lat1)*Math.PI/180;
  const dλ=(lng2-lng1)*Math.PI/180;
  const a=Math.sin(dφ/2)**2+Math.cos(φ1)*Math.cos(φ2)*Math.sin(dλ/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

/* ===== GPS → UI ===== */
function gpsToUI(lat,lng){
  const lot=document.getElementById("parking-lot");
  return {
    x:(lng-MIN_LNG)/(MAX_LNG-MIN_LNG)*lot.clientWidth,
    y:(MAX_LAT-lat)/(MAX_LAT-MIN_LAT)*lot.clientHeight
  };
}

/* ===== 2点の方位角 ===== */
function bearing(lat1,lng1,lat2,lng2){
  const φ1=lat1*Math.PI/180;
  const φ2=lat2*Math.PI/180;
  const λ1=lng1*Math.PI/180;
  const λ2=lng2*Math.PI/180;
  const y=Math.sin(λ2-λ1)*Math.cos(φ2);
  const x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(λ2-λ1);
  return (Math.atan2(y,x)*180/Math.PI+360)%360;
}

/* ===== 描画 ===== */
function render(){
  const lot=document.getElementById("parking-lot");
  const marker=document.getElementById("user-marker");
  const arrow=document.getElementById("arrow");

  document.querySelectorAll(".rod").forEach(e=>e.remove());

  let nearest=null, minDist=Infinity, nearestPos=null, userPos=null;

  if(userLat){
    userPos=gpsToUI(userLat,userLng);
    marker.style.left=(userPos.x-9)+"px";
    marker.style.top=(userPos.y-9)+"px";
    marker.style.display="block";
  }

  rods.forEach(r=>{
    if(userLat && r.status===0){
      r.dist=calcDistance(userLat,userLng,r.lat,r.lng);
      if(r.dist<minDist){
        minDist=r.dist;
        nearest=r.id;
        nearestPos=gpsToUI(r.lat,r.lng);
      }
    }

    const d=document.createElement("div");
    d.className="rod "+(r.status===0?"empty":"full");
    if(r.id===nearest) d.classList.add("nearest");

    d.innerHTML=`${r.label}<br>${r.status===0?"空き":"使用中"}${r.dist?`<div class="distance">${r.dist.toFixed(1)}m</div>`:""}`;
    d.style.left=((r.col-1)/3*100)+"%";
    d.style.top=((r.row-1)*22+30)+"%";
    lot.appendChild(d);
  });

  /* 矢印描画（傾き連動） */
  if(nearestPos && userPos){
    const targetBearing = bearing(userLat,userLng,
                                  rods.find(r=>r.id===nearest).lat,
                                  rods.find(r=>r.id===nearest).lng);
    let angleDeg = 0;
    if(deviceHeading!==null){
      angleDeg = targetBearing - deviceHeading;
    } else {
      const dx=nearestPos.x-userPos.x;
      const dy=nearestPos.y-userPos.y;
      angleDeg = Math.atan2(dy,dx)*180/Math.PI;
    }
    const dx=nearestPos.x-userPos.x;
    const dy=nearestPos.y-userPos.y;
    arrow.style.width=Math.hypot(dx,dy)+"px";
    arrow.style.left=userPos.x+"px";
    arrow.style.top=userPos.y+"px";
    arrow.style.transform=`rotate(${angleDeg}deg)`;
    arrow.style.display="block";
  }
}

/* ===== GPS取得 ===== */
navigator.geolocation.watchPosition(
  p=>{
    userLat=p.coords.latitude;
    userLng=p.coords.longitude;
    document.getElementById("location").textContent=
      `現在地：${userLat.toFixed(5)}, ${userLng.toFixed(5)}`;
    render();
  },
  ()=>document.getElementById("location").textContent="位置情報取得不可",
  {enableHighAccuracy:true}
);

/* ===== スマホ方位センサ ===== */
function requestOrientationPermission(){
  if(typeof DeviceOrientationEvent !== "undefined" &&
     typeof DeviceOrientationEvent.requestPermission === "function"){
    DeviceOrientationEvent.requestPermission().then(state=>{
      if(state==="granted"){
        window.addEventListener("deviceorientation", handleOrientation, true);
      }
    });
  }else{
    window.addEventListener("deviceorientation", handleOrientation, true);
  }
}

function handleOrientation(e){
  if(e.alpha!==null){
    deviceHeading = e.alpha;
    render();
  }
}
</script>

</body>
</html>