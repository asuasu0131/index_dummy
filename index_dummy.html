<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>駐車場 空き状況ナビ（矢印付き）</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
/* ===== デザインは完全にそのまま ===== */
body {
  font-family: sans-serif;
  background: #cfcfcf;
  padding: 8px;
  margin: 0;
  text-align: center;
}

h1 {
  font-size: clamp(18px, 4vw, 26px);
  margin: 6px 0;
}

#location {
  background: #fff;
  padding: 8px;
  margin-bottom: 8px;
  border-radius: 6px;
  font-size: clamp(12px, 3vw, 14px);
}

#parking-lot {
  position: relative;
  width: 100%;
  max-width: 900px;
  aspect-ratio: 9 / 6.5;
  margin: auto;
  background: #bfbfbf;
  overflow: hidden;
  border-radius: 10px;
}

.rod {
  position: absolute;
  width: 33.33%;
  height: 22%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  font-size: clamp(14px, 3.5vw, 24px);
  border-top: 3px solid white;
  border-bottom: 3px solid white;
  box-sizing: border-box;
}

.empty { background: #4caf50; }
.full  { background: #f44336; }

.nearest {
  outline: 4px solid yellow;
  box-shadow: 0 0 14px rgba(255,255,0,0.9);
}

#user-marker {
  position: absolute;
  width: 14px;
  height: 14px;
  background: #2196f3;
  border-radius: 50%;
  border: 2px solid white;
  z-index: 1000;
  display: none;
}

#arrow {
  position: absolute;
  height: 2px;
  background: red;
  transform-origin: left center;
  z-index: 900;
  display: none;
}

.distance {
  font-size: clamp(10px, 2.5vw, 14px);
}
</style>
</head>

<body>

<h1>駐車場 空き状況ナビ</h1>
<div id="location">慣性センサで位置推定中...</div>
<button id="enable-orientation">センサを有効化</button>

<div id="parking-lot">
  <div id="user-marker"></div>
  <div id="arrow"></div>
</div>

<script>
/* =============================
   駐車ロッド（位置はUI座標）
============================= */
const rods = [
  { id:"A1", label:"A1", x:0.17, y:0.35, status:0, row:1, col:1 },
  { id:"A2", label:"A2", x:0.17, y:0.55, status:1, row:2, col:1 },
  { id:"A3", label:"A3", x:0.17, y:0.75, status:0, row:3, col:1 },
  { id:"B1", label:"B1", x:0.83, y:0.35, status:0, row:1, col:3 },
  { id:"B2", label:"B2", x:0.83, y:0.55, status:1, row:2, col:3 },
  { id:"B3", label:"B3", x:0.83, y:0.75, status:0, row:3, col:3 }
];

/* =============================
   ユーザ位置（PDR）
============================= */
let userX = 0.5;
let userY = 0.8;
let deviceHeading = 0;
let lastStepTime = 0;

/* =============================
   歩行検出（簡易）
============================= */
window.addEventListener("devicemotion", e => {
  const acc = e.accelerationIncludingGravity;
  if (!acc) return;

  const mag = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);

  if (mag > 13) { // 歩行っぽい閾値
    const now = Date.now();
    if (now - lastStepTime > 400) {
      moveForward();
      lastStepTime = now;
    }
  }
});

/* =============================
   前進処理（向いている方向）
============================= */
function moveForward() {
  const step = 0.015;
  const rad = deviceHeading * Math.PI / 180;
  userX += step * Math.sin(rad);
  userY -= step * Math.cos(rad);

  userX = Math.max(0, Math.min(1, userX));
  userY = Math.max(0, Math.min(1, userY));

  render();
}

/* =============================
   描画
============================= */
function render(){
  const lot = document.getElementById("parking-lot");
  const marker = document.getElementById("user-marker");
  const arrow = document.getElementById("arrow");

  document.querySelectorAll(".rod").forEach(e=>e.remove());

  const ux = userX * lot.clientWidth;
  const uy = userY * lot.clientHeight;

  marker.style.left = (ux - 7) + "px";
  marker.style.top  = (uy - 7) + "px";
  marker.style.display = "block";

  let nearest=null, minDist=Infinity, tx, ty;

  rods.forEach(r=>{
    const rx = r.x * lot.clientWidth;
    const ry = r.y * lot.clientHeight;
    const d = Math.hypot(rx-ux, ry-uy);

    if (r.status===0 && d < minDist) {
      minDist = d;
      nearest = r;
      tx = rx;
      ty = ry;
    }

    const div=document.createElement("div");
    div.className="rod "+(r.status===0?"empty":"full");
    if(nearest===r) div.classList.add("nearest");
    div.innerHTML=`${r.label}<br>${r.status===0?"空き":"使用中"}`;
    div.style.left=((r.col-1)/3*100)+"%";
    div.style.top=((r.row-1)*22+30)+"%";
    lot.appendChild(div);
  });

  if(nearest){
    const dx=tx-ux, dy=ty-uy;
    arrow.style.width=Math.hypot(dx,dy)+"px";
    arrow.style.left=ux+"px";
    arrow.style.top=uy+"px";
    arrow.style.transform=`rotate(${Math.atan2(dx,-dy)*180/Math.PI}deg)`;
    arrow.style.display="block";
  }

  document.getElementById("location").textContent =
    `推定位置 X:${userX.toFixed(2)} Y:${userY.toFixed(2)}`;
}

/* =============================
   方位センサ
============================= */
document.getElementById("enable-orientation").addEventListener("click", ()=>{
  if (DeviceOrientationEvent.requestPermission) {
    DeviceOrientationEvent.requestPermission().then(p=>{
      if(p==="granted"){
        window.addEventListener("deviceorientation", e=>{
          deviceHeading = e.webkitCompassHeading ?? e.alpha ?? 0;
        });
        alert("慣性センサを有効化しました");
      }
    });
  } else {
    window.addEventListener("deviceorientation", e=>{
      deviceHeading = e.alpha ?? 0;
    });
    alert("慣性センサを有効化しました");
  }
});

render();
</script>

</body>
</html>