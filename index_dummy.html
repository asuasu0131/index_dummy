<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>駐車場 空き状況ナビ（1台1区画 × 6台）</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body {
  font-family: sans-serif;
  background: #cfcfcf;
  padding: 8px;
  margin: 0;
  text-align: center;
}

h1 {
  font-size: clamp(18px, 4vw, 26px);
  margin: 6px 0;
}

#location {
  background: #fff;
  padding: 8px;
  margin-bottom: 8px;
  border-radius: 6px;
  font-size: clamp(12px, 3vw, 14px);
}

#parking-lot {
  position: relative;
  width: 100%;
  max-width: 900px;
  aspect-ratio: 9/6.5;
  margin: auto;
  background: #bfbfbf;
  overflow: hidden;
  border-radius: 10px;
}

.rod {
  position: absolute;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  font-size: clamp(12px, 2.5vw, 20px);
  box-sizing: border-box;
  border: 2px solid white;
  border-radius: 4px;
}

.empty { background: #4caf50; }
.full  { background: #f44336; }

.nearest {
  outline: 4px solid yellow;
  box-shadow: 0 0 14px rgba(255,255,0,0.9);
}

#user-marker {
  position: absolute;
  width: 14px;
  height: 14px;
  background: #2196f3;
  border-radius: 50%;
  border: 2px solid white;
  z-index: 1000;
  display: none;
}

.user-marker-other {
  position: absolute;
  width: 12px;
  height: 12px;
  background: #ff9800;
  border: 2px solid white;
  border-radius: 50%;
  z-index: 999;
}

#arrow {
  position: absolute;
  height: 2px;
  background: red;
  transform-origin: left center;
  z-index: 900;
  display: none;
}
</style>
</head>

<body>
<h1>駐車場 空き状況ナビ（1台1区画 × 6台）</h1>
<div id="location">位置情報を取得中...</div>
<button id="enable-orientation">方位センサを有効化</button>

<div id="parking-lot">
  <div id="user-marker"></div>
  <div id="arrow"></div>
</div>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
// ===== 駐車ロッド情報（1台1区画 × 6台） =====
// 緯度経度は仮で駐車場内で並べています
let rods = [
  {id:"A1", label:"A1", lat:38.167760, lng:140.866330, status:0, top:30, left:5, width:28, height:20},
  {id:"A2", label:"A2", lat:38.167761, lng:140.866340, status:1, top:30, left:37, width:28, height:20},
  {id:"A3", label:"A3", lat:38.167762, lng:140.866350, status:0, top:30, left:69, width:28, height:20},
  {id:"B1", label:"B1", lat:38.167770, lng:140.866330, status:1, top:55, left:5, width:28, height:20},
  {id:"B2", label:"B2", lat:38.167771, lng:140.866340, status:0, top:55, left:37, width:28, height:20},
  {id:"B3", label:"B3", lat:38.167772, lng:140.866350, status:1, top:55, left:69, width:28, height:20}
];

let userLat=null, userLng=null, deviceHeading=null;
const myId = crypto.randomUUID();
let users = {};

// ===== 緯度経度 → UI座標変換 =====
function gpsToUI(lat,lng){
  const lot=document.getElementById("parking-lot");
  const minLat=38.167755, maxLat=38.167775;
  const minLng=140.866325, maxLng=140.866355;
  return {
    x:(lng-minLng)/(maxLng-minLng)*lot.clientWidth,
    y:(maxLat-lat)/(maxLat-minLat)*lot.clientHeight
  };
}

// ===== 距離計算（簡易） =====
function calcDistance(lat1,lng1,lat2,lng2){
  return Math.hypot(lat1-lat2, lng1-lng2);
}

// ===== 描画 =====
function render(){
  const lot=document.getElementById("parking-lot");
  const marker=document.getElementById("user-marker");
  const arrow=document.getElementById("arrow");

  document.querySelectorAll(".rod, .user-marker-other").forEach(e=>e.remove());

  let nearest=null, minDist=Infinity;
  let userPos=userLat&&userLng ? gpsToUI(userLat,userLng) : {x:lot.clientWidth/2,y:lot.clientHeight/2};

  if(userLat && userLng){
    marker.style.left=(userPos.x-7)+"px";
    marker.style.top=(userPos.y-7)+"px";
    marker.style.display="block";
  }

  // ===== ロッド描画 =====
  rods.forEach(r=>{
    if(userLat && r.status===0){
      const dist = calcDistance(userLat,userLng,r.lat,r.lng);
      if(dist<minDist){ minDist=dist; nearest=r.id; }
    }

    const d=document.createElement("div");
    d.className="rod "+(r.status===0?"empty":"full");
    if(r.id===nearest) d.classList.add("nearest");

    d.style.top=r.top+"%";
    d.style.left=r.left+"%";
    d.style.width=r.width+"%";
    d.style.height=r.height+"%";
    d.innerHTML=r.label+"<br>"+(r.status===0?"空き":"使用中");
    lot.appendChild(d);
  });

  // ===== 矢印描画 =====
  if(nearest){
    const target=rods.find(r=>r.id===nearest);
    const targetPos=gpsToUI(target.lat,target.lng);
    const dx=targetPos.x-userPos.x;
    const dy=targetPos.y-userPos.y;
    let angle=Math.atan2(dy,dx)*180/Math.PI;
    if(deviceHeading!==null) angle-=deviceHeading;

    arrow.style.width=Math.hypot(dx,dy)+"px";
    arrow.style.left=userPos.x+"px";
    arrow.style.top=userPos.y+"px";
    arrow.style.transform=`rotate(${angle}deg)`;
    arrow.style.display="block";
  }

  // ===== 他ユーザー描画 =====
  Object.entries(users).forEach(([id,info])=>{
    if(id===myId) return;
    const pos=gpsToUI(info.lat,info.lng);
    const other=document.createElement("div");
    other.className="user-marker-other";
    other.style.left=(pos.x-6)+"px";
    other.style.top=(pos.y-6)+"px";
    lot.appendChild(other);
  });
}

// ===== GPS取得 =====
navigator.geolocation.watchPosition(p=>{
  userLat=p.coords.latitude;
  userLng=p.coords.longitude;
  document.getElementById("location").textContent=
    `現在地：${userLat.toFixed(5)}, ${userLng.toFixed(5)}`;
  render();
},()=>document.getElementById("location").textContent="位置情報取得不可",{enableHighAccuracy:true});

// ===== 方位センサ =====
document.getElementById("enable-orientation").addEventListener("click", ()=>{
  if(typeof DeviceOrientationEvent!=="undefined" &&
     typeof DeviceOrientationEvent.requestPermission==="function"){
    DeviceOrientationEvent.requestPermission().then(state=>{
      if(state==="granted"){window.addEventListener("deviceorientation", handleOrientation,true);}
    });
  } else{
    window.addEventListener("deviceorientationabsolute", handleOrientation,true);
    window.addEventListener("deviceorientation", handleOrientation,true);
  }
});

function handleOrientation(e){
  if(e.webkitCompassHeading!==undefined) deviceHeading=e.webkitCompassHeading;
  else if(e.absolute && e.alpha!==null) deviceHeading=e.alpha;
  else if(e.alpha!==null) deviceHeading=e.alpha;
  render();
}
</script>
</body>
</html>